# Log4J-Mitigation-CVE-2021-44228

**Background:**

Internet discussion was abuzz about a 0-day vulnerability (one that can yield remote code execution) in Apache’s popular Log4J logging library for Java. This particular vulnerability–tracked as CVE-2021-44228 with the maximum “critical” CVSS score of 10–resides in Log4J’s lookup capability, combined with JNDI (Java Naming and Directory Interface). This issue is widespread because many developers were unaware that Log4J was dangerous to use with unfiltered input.

The most significant impact is that an attacker can cause a string to reach the logger, that when processed by Log4J, executes arbitrary code. The first examples of this used the ${jndi:ldap} path, which could lead to arbitrary code being loaded from a remote URL. This path is partially mitigated by the use of newer Java runtimes that block the URL-based class loader by default. Unfortunately, a modern version of Java may not be enough to prevent exploitation, as the application itself may expose classes that can be used to run arbitrary code.

**The JNDI architecture:**

![jndiarch](https://user-images.githubusercontent.com/27088213/145769582-f620cb3f-3bfb-49b0-9203-1356b9a4f15c.jpg)


**Mitigations for Different environments:**

     1. Apache Log4j:
            In releases >=2.10** and
            For releases >=2.0-beta9 and <=2.10.0
            
    2. pom.xml Fix:
     
    3. Azure App Service (Windows and Linux):
     
    4. Any Containerized applications:
     
    5. Azure Functions:

**1. Apache Log4j:** 

CVE-2021-44228: Apache Log4j2 JNDI features do not protect against attacker controlled LDAP and other JNDI related endpoints.

Versions Affected: all log4j-core versions >=2.0-beta9 and <=2.14.1
Apache Log4j <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default.

 **In releases >=2.10****, this behavior can be mitigated by setting either the system property log4j2.formatMsgNoLookups or the `environment variable LOG4J_FORMAT_MSG_NO_LOOKUPS to true`. For releases >=2.7 and <=2.14.1, all PatternLayout patterns can be modified to specify the message converter as %m{nolookups} instead of just %m. 
 
**For releases >=2.0-beta9 and <=2.10.0**, the mitigation is to remove the JndiLookup class from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`.

**2.pom.xml Fix:**

Update the dependency in pom.xml and swap with the latest available version in the dependencies section :
https://search.maven.org/artifact/org.apache.logging.log4j/log4j/2.15.0/pom

    <dependencies>
            <dependency>
                <groupId>org.apache.logging.log4j</groupId>
                <artifactId>log4j-core</artifactId>
                <version>2.14.1</version>
    <!-- Swap with the below to prove it's fixed -->            
    <!--         <version>2.15.0</version>-->
            </dependency>
            <dependency>
                <groupId>org.apache.logging.log4j</groupId>
                <artifactId>log4j-api</artifactId>
                <version>2.14.1</version>
    <!-- Swap with the below to prove it's fixed -->       
    <!--         <version>2.15.0</version>-->
            </dependency>
        </dependencies>
   Reference: https://github.com/justincormack/log4jpoc/blob/main/pom.xml#L18

**3.Azure App Service (Windows and Linux):**

If possible, customers should upgrade Log4j to version v2.15.0 and re-deploy applications. This is the primary recommended mitigation. If you are not able to re-deploy your application, then in Log4j versions 2.10 and greater, you can mitigate this behavior by setting the system property “-Dlog4j2.formatMsgNoLookups=true”. On App Service, you can set this property by creating an app setting named JAVA_OPTS with a value of “-Dlog4j2.formatMsgNoLookups=true”. The JAVA_OPTS app setting is passed to your Java application as it starts. If you already have the JAVA_OPTS app setting set, just append “-Dlog4j2.formatMsgNoLookups=true” to the existing value. If you are using Log4J version 2.9 or lower, this system property mitigation will not work and you should upgrade to v2.15.0.

    az webapp config appsettings set --name <app-name> --resource-group <resource-group-name> --settings <setting-name>="<value>"
    az webapp config appsettings set --name <app-name> --resource-group <resource-group-name> --settings JAVA_OPTS="-Dlog4j2.formatMsgNoLookups=true"

**4.Any Containerized applications**

 - For containerized applications, if the version of Log4j 2 you are
    using is 2.10.0 or later, there is an environment variable or Java
    command line option you can use to disable the unsafe substitution
    behavior. You can add the line:
    
        ENV LOG4J_FORMAT_MSG_NO_LOOKUPS=true
    
    Docker file reference:
    https://github.com/lhotari/Log4Shell-mitigation-Dockerfile-overlay/blob/master/Dockerfile
 - To your Dockerfile, or you can add the equivalent flag
    "-Dlog4j.formatMsgNoLookups=true"to the command you run in your
    container, for example:
    
        CMD ["java", "-Dlog4j.formatMsgNoLookups=true", "-jar", "..."]
 - You can also configure the environment variable at runtime, which
    can be easier, for example for Kubernetes you could add these lines
    into your configuration.
    
        spec:
          containers:
          - name: ...
            image: ...
            env:
            - name: LOG4J_FORMAT_MSG_NO_LOOKUPS
              value: "true"

 **5.Azure Functions:**
 
Configuring the system property will depend on your choice of hosting option: dedicated, premium or consumption. As a reminder, the primary recommended mitigation is upgrading Log4J to 2.15.0 and re-deploying your application. If you cannot do that for whatever reason, then you can apply the system property.

  **- Dedicated and Premium Functions:**

Create an app setting named JAVA_OPTS with a value of “-Dlog4j2.formatMsgNoLookups=true”. If you already have the JAVA_OPTS app setting set, just append “-Dlog4j2.formatMsgNoLookups=true” to the existing value.

  **- Consumption Functions:**

Linux: Create an app setting named “languageWorkers__java__arguments” with a value of “-Dlog4j2.formatMsgNoLookups=true”.
Windows: Create an app setting named “languageWorkers:java:arguments” with a value of “-Dlog4j2.formatMsgNoLookups=true”. 
**Note that updating app setting will restart your Web and Function apps, which could affect cold start performance. If you are using Log4J version 2.9 or lower, this system property mitigation will not work and you should upgrade to v2.15.0.

**Contributing:**

Happy to recieve contributions from the community. Contribution guidelines:

-->Please make a PR.

-->Please be sure to include a reference source for more context

**There may be several different environments and other ways to fix ,feel free to open a pull request :**



**References:**

https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/

https://www.docker.com/blog/apache-log4j-2-cve-2021-44228/

https://github.com/justincormack/log4jpoc

https://www.rumble.run/blog/finding-log4j/

https://www.veracode.com/blog/research/exploiting-jndi-injections-java

https://github.com/lhotari/Log4Shell-mitigation-Dockerfile-overlay

https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/index.html

https://logging.apache.org/log4j/2.x/security.html
